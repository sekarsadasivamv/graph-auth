import { __assign, __decorate, __extends, __param } from "tslib";
import { Inject, Injectable } from "@angular/core";
import { UserAgentApplication } from "msal";
import { Router } from "@angular/router";
import { BroadcastService } from "./broadcast.service";
import { MSALError } from "./MSALError";
import { UrlUtils } from "msal/lib-commonjs/utils/UrlUtils";
import { MSAL_CONFIG, MSAL_CONFIG_ANGULAR } from "./constants";
var buildMsalConfig = function (config) {
    return __assign(__assign({}, config), { framework: __assign(__assign({}, config.framework), { isAngular: true }) });
};
var ɵ0 = buildMsalConfig;
var MsalService = /** @class */ (function (_super) {
    __extends(MsalService, _super);
    function MsalService(msalConfig, msalAngularConfig, router, broadcastService) {
        var _this = _super.call(this, buildMsalConfig(msalConfig)) || this;
        _this.msalConfig = msalConfig;
        _this.msalAngularConfig = msalAngularConfig;
        _this.router = router;
        _this.broadcastService = broadcastService;
        window.addEventListener("msal:popUpHashChanged", function (e) {
            _this.getLogger().verbose("popUpHashChanged ");
        });
        window.addEventListener('msal:popUpClosed', function (e) {
            var errorParts = e.detail.split('|');
            var msalError = new MSALError(errorParts[0], errorParts[1]);
            if (_this.getLoginInProgress()) {
                broadcastService.broadcast('msal:loginFailure', msalError);
                _this.setloginInProgress(false);
            }
            else if (_this.getAcquireTokenInProgress()) {
                broadcastService.broadcast('msal:acquireTokenFailure', msalError);
                _this.setAcquireTokenInProgress(false);
            }
        });
        _this.router.events.subscribe(function (event) {
            for (var i = 0; i < router.config.length; i++) {
                if (!router.config[i].canActivate) {
                    if (_this.msalAngularConfig.unprotectedResources) {
                        if (!_this.isUnprotectedResource(router.config[i].path) && !_this.isEmpty(router.config[i].path)) {
                            _this.msalAngularConfig.unprotectedResources.push(router.config[i].path);
                        }
                    }
                }
            }
        });
        return _this;
    }
    MsalService.prototype.isUnprotectedResource = function (url) {
        var frameworkUnprotectedResources = this.msalConfig.framework && this.msalConfig.framework.unprotectedResources;
        var configUnprotectedResources = this.msalAngularConfig.unprotectedResources || [];
        var unprotectedResources = frameworkUnprotectedResources && frameworkUnprotectedResources.length ? frameworkUnprotectedResources : configUnprotectedResources;
        return unprotectedResources.some(function (resource) { return url.indexOf(resource) > -1; });
    };
    MsalService.prototype.isEmpty = function (str) {
        return (typeof str === "undefined" || !str || 0 === str.length);
    };
    MsalService.prototype.getCacheStorage = function () {
        return this.cacheStorage;
    };
    MsalService.prototype.loginPopup = function (request) {
        var _this = this;
        return _super.prototype.loginPopup.call(this, request)
            .then(function (authResponse) {
            _this.broadcastService.broadcast("msal:loginSuccess", authResponse);
            return authResponse;
        })
            .catch(function (error) {
            _this.broadcastService.broadcast("msal:loginFailure", error);
            _this.getLogger().error("Error during login:\n" + error.errorMessage);
            throw error;
        });
    };
    MsalService.prototype.acquireTokenSilent = function (request) {
        var _this = this;
        return _super.prototype.acquireTokenSilent.call(this, request)
            .then(function (authResponse) {
            _this.broadcastService.broadcast('msal:acquireTokenSuccess', authResponse);
            return authResponse;
        })
            .catch(function (error) {
            _this.broadcastService.broadcast('msal:acquireTokenFailure', error);
            _this.getLogger().error('Error when acquiring token for scopes: ' + request.scopes + " " + error);
            throw error;
        });
    };
    MsalService.prototype.acquireTokenPopup = function (request) {
        var _this = this;
        return _super.prototype.acquireTokenPopup.call(this, request)
            .then(function (authResponse) {
            _this.broadcastService.broadcast('msal:acquireTokenSuccess', authResponse);
            return authResponse;
        })
            .catch(function (error) {
            _this.broadcastService.broadcast('msal:acquireTokenFailure', error);
            _this.getLogger().error('Error when acquiring token for scopes : ' + request.scopes + " " + error);
            throw error;
        });
    };
    MsalService.prototype.handleRedirectCallback = function (authOrTokenCallback, errorReceivedCallback) {
        var _this = this;
        _super.prototype.handleRedirectCallback.call(this, function (authError, authResponse) {
            if (authResponse) {
                if (authResponse.tokenType === "id_token") {
                    _this.broadcastService.broadcast("msal:loginSuccess", authResponse);
                }
                else {
                    _this.broadcastService.broadcast("msal:acquireTokenSuccess", authResponse);
                }
                if (errorReceivedCallback) {
                    authOrTokenCallback(authResponse);
                }
                else {
                    authOrTokenCallback(null, authResponse);
                }
            }
            else if (authError) {
                if (authResponse.tokenType === "id_token") {
                    _this.broadcastService.broadcast("msal:loginFailure", authError);
                }
                else {
                    _this.broadcastService.broadcast("msal:acquireTokenFailure", authError);
                }
                if (errorReceivedCallback) {
                    errorReceivedCallback(authError, authResponse.accountState);
                }
                else {
                    authOrTokenCallback(authError);
                }
            }
        });
    };
    MsalService.prototype.clearCacheForScope = function (accessToken) {
        return _super.prototype.clearCacheForScope.call(this, accessToken);
    };
    MsalService.prototype.getScopesForEndpoint = function (endpoint) {
        if (this.msalConfig.framework && this.msalConfig.framework.unprotectedResources) {
            this.getLogger().info("msalConfig.framework.unprotectedResources is deprecated, use msalAngularConfig.unprotectedResources");
        }
        // if user specified list of unprotectedResources, no need to send token to these endpoints, return null.
        var isUnprotected = this.isUnprotectedResource(endpoint);
        if (isUnprotected) {
            return null;
        }
        var frameworkProtectedResourceMap = this.msalConfig.framework && this.msalConfig.framework.protectedResourceMap;
        if (frameworkProtectedResourceMap) {
            this.getLogger().info("msalConfig.framework.protectedResourceMap is deprecated, use msalAngularConfig.protectedResourceMap");
        }
        var protectedResourceMap = frameworkProtectedResourceMap && frameworkProtectedResourceMap.size ? frameworkProtectedResourceMap : new Map(this.msalAngularConfig.protectedResourceMap);
        // process all protected resources and send the matched one
        var keyForEndpoint = Array.from(protectedResourceMap.keys()).find(function (key) { return endpoint.indexOf(key) > -1; });
        if (keyForEndpoint) {
            return protectedResourceMap.get(keyForEndpoint);
        }
        /*
         * default resource will be clientid if nothing specified
         * App will use idtoken for calls to itself
         * check if it's staring from http or https, needs to match with app host
         */
        if (endpoint.indexOf("http://") > -1 || endpoint.indexOf("https://") > -1) {
            if (UrlUtils.getHostFromUri(endpoint) === UrlUtils.getHostFromUri(_super.prototype.getRedirectUri.call(this))) {
                return new Array(this.msalConfig.auth.clientId);
            }
        }
        else {
            /*
             * in angular level, the url for $http interceptor call could be relative url,
             * if it's relative call, we'll treat it as app backend call.
             */
            return new Array(this.msalConfig.auth.clientId);
        }
        // if not the app's own backend or not a domain listed in the endpoints structure
        return null;
    };
    MsalService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [MSAL_CONFIG,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [MSAL_CONFIG_ANGULAR,] }] },
        { type: Router },
        { type: BroadcastService }
    ]; };
    MsalService = __decorate([
        Injectable(),
        __param(0, Inject(MSAL_CONFIG)),
        __param(1, Inject(MSAL_CONFIG_ANGULAR))
    ], MsalService);
    return MsalService;
}(UserAgentApplication));
export { MsalService };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXNhbC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF6dXJlL21zYWwtYW5ndWxhci8iLCJzb3VyY2VzIjpbInNyYy9tc2FsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUNqRSxPQUFPLEVBQ0gsb0JBQW9CLEVBTXZCLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUNGLE1BQU0sRUFDVixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHFCQUFxQixDQUFDO0FBQ3JELE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFJdEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxXQUFXLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFL0QsSUFBTSxlQUFlLEdBQUcsVUFBQyxNQUFxQjtJQUMxQyw2QkFDTyxNQUFNLEtBQ1QsU0FBUyx3QkFDRixNQUFNLENBQUMsU0FBUyxLQUNuQixTQUFTLEVBQUUsSUFBSSxPQUVyQjtBQUNOLENBQUMsQ0FBQzs7QUFHRjtJQUFpQywrQkFBb0I7SUFFakQscUJBQ2lDLFVBQXlCLEVBQ2pCLGlCQUEyQyxFQUN4RSxNQUFjLEVBQ2QsZ0JBQWtDO1FBSjlDLFlBTUksa0JBQU0sZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFNBOEJyQztRQW5DZ0MsZ0JBQVUsR0FBVixVQUFVLENBQWU7UUFDakIsdUJBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUN4RSxZQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2Qsc0JBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUkxQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsdUJBQXVCLEVBQUUsVUFBQyxDQUFjO1lBQzVELEtBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxP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QUFDLFdBQVcsQ0FBQyxDQUFBO1FBQ25CLFdBQUEsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUE7T0FKdkIsV0FBVyxDQW9MdkI7SUFBRCxrQkFBQztDQUFBLEFBcExELENBQWlDLG9CQUFvQixHQW9McEQ7U0FwTFksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHtcclxuICAgIFVzZXJBZ2VudEFwcGxpY2F0aW9uLFxyXG4gICAgQ29uZmlndXJhdGlvbixcclxuICAgIEF1dGhlbnRpY2F0aW9uUGFyYW1ldGVycyxcclxuICAgIEF1dGhSZXNwb25zZSxcclxuICAgIEF1dGhFcnJvcixcclxuICAgIExvZ2dlclxyXG59IGZyb20gXCJtc2FsXCI7XHJcbmltcG9ydCB7XHJcbiAgICAgUm91dGVyXHJcbn0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xyXG5pbXBvcnQge0Jyb2FkY2FzdFNlcnZpY2V9IGZyb20gXCIuL2Jyb2FkY2FzdC5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7TVNBTEVycm9yfSBmcm9tIFwiLi9NU0FMRXJyb3JcIjtcclxuaW1wb3J0IHsgQXV0aENhY2hlIH0gZnJvbSBcIm1zYWwvbGliLWNvbW1vbmpzL2NhY2hlL0F1dGhDYWNoZVwiO1xyXG5pbXBvcnQgeyBNc2FsQW5ndWxhckNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi9tc2FsLWFuZ3VsYXIuY29uZmlndXJhdGlvblwiO1xyXG5pbXBvcnQgeyBhdXRoUmVzcG9uc2VDYWxsYmFjaywgZXJyb3JSZWNlaXZlZENhbGxiYWNrLCB0b2tlblJlY2VpdmVkQ2FsbGJhY2sgfSBmcm9tIFwibXNhbC9saWItY29tbW9uanMvVXNlckFnZW50QXBwbGljYXRpb25cIjtcclxuaW1wb3J0IHsgVXJsVXRpbHMgfSBmcm9tIFwibXNhbC9saWItY29tbW9uanMvdXRpbHMvVXJsVXRpbHNcIjtcclxuaW1wb3J0IHsgTVNBTF9DT05GSUcsIE1TQUxfQ09ORklHX0FOR1VMQVIgfSBmcm9tIFwiLi9jb25zdGFudHNcIjtcclxuXHJcbmNvbnN0IGJ1aWxkTXNhbENvbmZpZyA9IChjb25maWc6IENvbmZpZ3VyYXRpb24pIDogQ29uZmlndXJhdGlvbiA9PiB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLmNvbmZpZyxcclxuICAgICAgICBmcmFtZXdvcms6IHtcclxuICAgICAgICAgICAgLi4uY29uZmlnLmZyYW1ld29yayxcclxuICAgICAgICAgICAgaXNBbmd1bGFyOiB0cnVlXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE1zYWxTZXJ2aWNlIGV4dGVuZHMgVXNlckFnZW50QXBwbGljYXRpb24ge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIEBJbmplY3QoTVNBTF9DT05GSUcpIHByaXZhdGUgbXNhbENvbmZpZzogQ29uZmlndXJhdGlvbixcclxuICAgICAgICBASW5qZWN0KE1TQUxfQ09ORklHX0FOR1VMQVIpIHByaXZhdGUgbXNhbEFuZ3VsYXJDb25maWc6IE1zYWxBbmd1bGFyQ29uZmlndXJhdGlvbixcclxuICAgICAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxyXG4gICAgICAgIHByaXZhdGUgYnJvYWRjYXN0U2VydmljZTogQnJvYWRjYXN0U2VydmljZVxyXG4gICAgKSB7XHJcbiAgICAgICAgc3VwZXIoYnVpbGRNc2FsQ29uZmlnKG1zYWxDb25maWcpKTtcclxuXHJcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJtc2FsOnBvcFVwSGFzaENoYW5nZWRcIiwgKGU6IEN1c3RvbUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkudmVyYm9zZShcInBvcFVwSGFzaENoYW5nZWQgXCIpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbXNhbDpwb3BVcENsb3NlZCcsIChlOiBDdXN0b21FdmVudCkgPT4ge1xyXG4gICAgICAgICAgICB2YXIgZXJyb3JQYXJ0cyA9IGUuZGV0YWlsLnNwbGl0KCd8Jyk7XHJcbiAgICAgICAgICAgIHZhciBtc2FsRXJyb3IgPSBuZXcgTVNBTEVycm9yKGVycm9yUGFydHNbMF0sIGVycm9yUGFydHNbMV0pO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5nZXRMb2dpbkluUHJvZ3Jlc3MoKSkge1xyXG4gICAgICAgICAgICAgICAgYnJvYWRjYXN0U2VydmljZS5icm9hZGNhc3QoJ21zYWw6bG9naW5GYWlsdXJlJywgbXNhbEVycm9yKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0bG9naW5JblByb2dyZXNzKGZhbHNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLmdldEFjcXVpcmVUb2tlbkluUHJvZ3Jlc3MoKSkge1xyXG4gICAgICAgICAgICAgICAgYnJvYWRjYXN0U2VydmljZS5icm9hZGNhc3QoJ21zYWw6YWNxdWlyZVRva2VuRmFpbHVyZScsIG1zYWxFcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldEFjcXVpcmVUb2tlbkluUHJvZ3Jlc3MoZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMucm91dGVyLmV2ZW50cy5zdWJzY3JpYmUoZXZlbnQgPT4ge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdXRlci5jb25maWcubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICghcm91dGVyLmNvbmZpZ1tpXS5jYW5BY3RpdmF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1zYWxBbmd1bGFyQ29uZmlnLnVucHJvdGVjdGVkUmVzb3VyY2VzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1VucHJvdGVjdGVkUmVzb3VyY2Uocm91dGVyLmNvbmZpZ1tpXS5wYXRoKSAmJiAhdGhpcy5pc0VtcHR5KHJvdXRlci5jb25maWdbaV0ucGF0aCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubXNhbEFuZ3VsYXJDb25maWcudW5wcm90ZWN0ZWRSZXNvdXJjZXMucHVzaChyb3V0ZXIuY29uZmlnW2ldLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc1VucHJvdGVjdGVkUmVzb3VyY2UodXJsOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCBmcmFtZXdvcmtVbnByb3RlY3RlZFJlc291cmNlcyA9IHRoaXMubXNhbENvbmZpZy5mcmFtZXdvcmsgJiYgdGhpcy5tc2FsQ29uZmlnLmZyYW1ld29yay51bnByb3RlY3RlZFJlc291cmNlcztcclxuICAgICAgICBjb25zdCBjb25maWdVbnByb3RlY3RlZFJlc291cmNlcyA9IHRoaXMubXNhbEFuZ3VsYXJDb25maWcudW5wcm90ZWN0ZWRSZXNvdXJjZXMgfHwgW107XHJcblxyXG4gICAgICAgIGNvbnN0IHVucHJvdGVjdGVkUmVzb3VyY2VzID0gZnJhbWV3b3JrVW5wcm90ZWN0ZWRSZXNvdXJjZXMgJiYgZnJhbWV3b3JrVW5wcm90ZWN0ZWRSZXNvdXJjZXMubGVuZ3RoID8gZnJhbWV3b3JrVW5wcm90ZWN0ZWRSZXNvdXJjZXMgOiBjb25maWdVbnByb3RlY3RlZFJlc291cmNlcztcclxuXHJcbiAgICAgICAgcmV0dXJuIHVucHJvdGVjdGVkUmVzb3VyY2VzLnNvbWUocmVzb3VyY2UgPT4gdXJsLmluZGV4T2YocmVzb3VyY2UpID4gLTEpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNFbXB0eShzdHI6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAodHlwZW9mIHN0ciA9PT0gXCJ1bmRlZmluZWRcIiB8fCAhc3RyIHx8IDAgPT09IHN0ci5sZW5ndGgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRDYWNoZVN0b3JhZ2UoKTogQXV0aENhY2hlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jYWNoZVN0b3JhZ2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGxvZ2luUG9wdXAocmVxdWVzdD86IEF1dGhlbnRpY2F0aW9uUGFyYW1ldGVycyk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgcmV0dXJuIHN1cGVyLmxvZ2luUG9wdXAocmVxdWVzdClcclxuICAgICAgICAgICAgLnRoZW4oKGF1dGhSZXNwb25zZTogQXV0aFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDpsb2dpblN1Y2Nlc3NcIiwgYXV0aFJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhdXRoUmVzcG9uc2U7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEF1dGhFcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6bG9naW5GYWlsdXJlXCIsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkuZXJyb3IoXCJFcnJvciBkdXJpbmcgbG9naW46XFxuXCIgKyBlcnJvci5lcnJvck1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhY3F1aXJlVG9rZW5TaWxlbnQocmVxdWVzdDogQXV0aGVudGljYXRpb25QYXJhbWV0ZXJzKTogUHJvbWlzZTxBdXRoUmVzcG9uc2U+IHtcclxuICAgICAgICByZXR1cm4gc3VwZXIuYWNxdWlyZVRva2VuU2lsZW50KHJlcXVlc3QpXHJcbiAgICAgICAgICAgIC50aGVuKChhdXRoUmVzcG9uc2U6IEF1dGhSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdCgnbXNhbDphY3F1aXJlVG9rZW5TdWNjZXNzJywgYXV0aFJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhdXRoUmVzcG9uc2U7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEF1dGhFcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdCgnbXNhbDphY3F1aXJlVG9rZW5GYWlsdXJlJywgZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRMb2dnZXIoKS5lcnJvcignRXJyb3Igd2hlbiBhY3F1aXJpbmcgdG9rZW4gZm9yIHNjb3BlczogJyArIHJlcXVlc3Quc2NvcGVzICsgXCIgXCIgKyBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhY3F1aXJlVG9rZW5Qb3B1cChyZXF1ZXN0OiBBdXRoZW50aWNhdGlvblBhcmFtZXRlcnMpOiBQcm9taXNlPEF1dGhSZXNwb25zZT4ge1xyXG4gICAgICAgIHJldHVybiBzdXBlci5hY3F1aXJlVG9rZW5Qb3B1cChyZXF1ZXN0KVxyXG4gICAgICAgICAgICAudGhlbigoYXV0aFJlc3BvbnNlOiBBdXRoUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYnJvYWRjYXN0U2VydmljZS5icm9hZGNhc3QoJ21zYWw6YWNxdWlyZVRva2VuU3VjY2VzcycsIGF1dGhSZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXV0aFJlc3BvbnNlO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goKGVycm9yOiBBdXRoRXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYnJvYWRjYXN0U2VydmljZS5icm9hZGNhc3QoJ21zYWw6YWNxdWlyZVRva2VuRmFpbHVyZScsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkuZXJyb3IoJ0Vycm9yIHdoZW4gYWNxdWlyaW5nIHRva2VuIGZvciBzY29wZXMgOiAnICsgcmVxdWVzdC5zY29wZXMgK1wiIFwiKyAgZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGhhbmRsZVJlZGlyZWN0Q2FsbGJhY2sodG9rZW5SZWNlaXZlZENhbGxiYWNrOiB0b2tlblJlY2VpdmVkQ2FsbGJhY2ssIGVycm9yUmVjZWl2ZWRDYWxsYmFjazogZXJyb3JSZWNlaXZlZENhbGxiYWNrKTogdm9pZDtcclxuICAgIGhhbmRsZVJlZGlyZWN0Q2FsbGJhY2soYXV0aENhbGxiYWNrOiBhdXRoUmVzcG9uc2VDYWxsYmFjayk6IHZvaWQ7XHJcbiAgICBoYW5kbGVSZWRpcmVjdENhbGxiYWNrKGF1dGhPclRva2VuQ2FsbGJhY2s6IGF1dGhSZXNwb25zZUNhbGxiYWNrIHwgdG9rZW5SZWNlaXZlZENhbGxiYWNrLCBlcnJvclJlY2VpdmVkQ2FsbGJhY2s/OiBlcnJvclJlY2VpdmVkQ2FsbGJhY2spOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5oYW5kbGVSZWRpcmVjdENhbGxiYWNrKChhdXRoRXJyb3I6IEF1dGhFcnJvciwgYXV0aFJlc3BvbnNlOiBBdXRoUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgaWYgKGF1dGhSZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGF1dGhSZXNwb25zZS50b2tlblR5cGUgPT09IFwiaWRfdG9rZW5cIikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYnJvYWRjYXN0U2VydmljZS5icm9hZGNhc3QoXCJtc2FsOmxvZ2luU3VjY2Vzc1wiLCBhdXRoUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDphY3F1aXJlVG9rZW5TdWNjZXNzXCIsIGF1dGhSZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yUmVjZWl2ZWRDYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgICAgIChhdXRoT3JUb2tlbkNhbGxiYWNrIGFzIHRva2VuUmVjZWl2ZWRDYWxsYmFjaykoYXV0aFJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgKGF1dGhPclRva2VuQ2FsbGJhY2sgYXMgYXV0aFJlc3BvbnNlQ2FsbGJhY2spKG51bGwsIGF1dGhSZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGF1dGhFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGF1dGhSZXNwb25zZS50b2tlblR5cGUgPT09IFwiaWRfdG9rZW5cIikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYnJvYWRjYXN0U2VydmljZS5icm9hZGNhc3QoXCJtc2FsOmxvZ2luRmFpbHVyZVwiLCBhdXRoRXJyb3IpO1xyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6YWNxdWlyZVRva2VuRmFpbHVyZVwiLCBhdXRoRXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChlcnJvclJlY2VpdmVkQ2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICBlcnJvclJlY2VpdmVkQ2FsbGJhY2soYXV0aEVycm9yLCBhdXRoUmVzcG9uc2UuYWNjb3VudFN0YXRlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgKGF1dGhPclRva2VuQ2FsbGJhY2sgYXMgYXV0aFJlc3BvbnNlQ2FsbGJhY2spKGF1dGhFcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsZWFyQ2FjaGVGb3JTY29wZShhY2Nlc3NUb2tlbjogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHN1cGVyLmNsZWFyQ2FjaGVGb3JTY29wZShhY2Nlc3NUb2tlbik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFNjb3Blc0ZvckVuZHBvaW50KGVuZHBvaW50OiBzdHJpbmcpIDogQXJyYXk8c3RyaW5nPiB7XHJcbiAgICAgICAgaWYgKHRoaXMubXNhbENvbmZpZy5mcmFtZXdvcmsgJiYgdGhpcy5tc2FsQ29uZmlnLmZyYW1ld29yay51bnByb3RlY3RlZFJlc291cmNlcykge1xyXG4gICAgICAgICAgICB0aGlzLmdldExvZ2dlcigpLmluZm8oXCJtc2FsQ29uZmlnLmZyYW1ld29yay51bnByb3RlY3RlZFJlc291cmNlcyBpcyBkZXByZWNhdGVkLCB1c2UgbXNhbEFuZ3VsYXJDb25maWcudW5wcm90ZWN0ZWRSZXNvdXJjZXNcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBpZiB1c2VyIHNwZWNpZmllZCBsaXN0IG9mIHVucHJvdGVjdGVkUmVzb3VyY2VzLCBubyBuZWVkIHRvIHNlbmQgdG9rZW4gdG8gdGhlc2UgZW5kcG9pbnRzLCByZXR1cm4gbnVsbC5cclxuICAgICAgICBjb25zdCBpc1VucHJvdGVjdGVkID0gdGhpcy5pc1VucHJvdGVjdGVkUmVzb3VyY2UoZW5kcG9pbnQpO1xyXG4gICAgICAgIGlmIChpc1VucHJvdGVjdGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZnJhbWV3b3JrUHJvdGVjdGVkUmVzb3VyY2VNYXAgPSB0aGlzLm1zYWxDb25maWcuZnJhbWV3b3JrICYmIHRoaXMubXNhbENvbmZpZy5mcmFtZXdvcmsucHJvdGVjdGVkUmVzb3VyY2VNYXA7XHJcbiAgICAgICAgaWYgKGZyYW1ld29ya1Byb3RlY3RlZFJlc291cmNlTWFwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkuaW5mbyhcIm1zYWxDb25maWcuZnJhbWV3b3JrLnByb3RlY3RlZFJlc291cmNlTWFwIGlzIGRlcHJlY2F0ZWQsIHVzZSBtc2FsQW5ndWxhckNvbmZpZy5wcm90ZWN0ZWRSZXNvdXJjZU1hcFwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHByb3RlY3RlZFJlc291cmNlTWFwID0gZnJhbWV3b3JrUHJvdGVjdGVkUmVzb3VyY2VNYXAgJiYgZnJhbWV3b3JrUHJvdGVjdGVkUmVzb3VyY2VNYXAuc2l6ZSA/IGZyYW1ld29ya1Byb3RlY3RlZFJlc291cmNlTWFwIDogbmV3IE1hcCh0aGlzLm1zYWxBbmd1bGFyQ29uZmlnLnByb3RlY3RlZFJlc291cmNlTWFwKTtcclxuXHJcbiAgICAgICAgLy8gcHJvY2VzcyBhbGwgcHJvdGVjdGVkIHJlc291cmNlcyBhbmQgc2VuZCB0aGUgbWF0Y2hlZCBvbmVcclxuICAgICAgICBjb25zdCBrZXlGb3JFbmRwb2ludCA9IEFycmF5LmZyb20ocHJvdGVjdGVkUmVzb3VyY2VNYXAua2V5cygpKS5maW5kKGtleSA9PiBlbmRwb2ludC5pbmRleE9mKGtleSkgPiAtMSk7XHJcbiAgICAgICAgaWYgKGtleUZvckVuZHBvaW50KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcm90ZWN0ZWRSZXNvdXJjZU1hcC5nZXQoa2V5Rm9yRW5kcG9pbnQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLypcclxuICAgICAgICAgKiBkZWZhdWx0IHJlc291cmNlIHdpbGwgYmUgY2xpZW50aWQgaWYgbm90aGluZyBzcGVjaWZpZWRcclxuICAgICAgICAgKiBBcHAgd2lsbCB1c2UgaWR0b2tlbiBmb3IgY2FsbHMgdG8gaXRzZWxmXHJcbiAgICAgICAgICogY2hlY2sgaWYgaXQncyBzdGFyaW5nIGZyb20gaHR0cCBvciBodHRwcywgbmVlZHMgdG8gbWF0Y2ggd2l0aCBhcHAgaG9zdFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGlmIChlbmRwb2ludC5pbmRleE9mKFwiaHR0cDovL1wiKSA+IC0xIHx8IGVuZHBvaW50LmluZGV4T2YoXCJodHRwczovL1wiKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIGlmIChVcmxVdGlscy5nZXRIb3N0RnJvbVVyaShlbmRwb2ludCkgPT09IFVybFV0aWxzLmdldEhvc3RGcm9tVXJpKHN1cGVyLmdldFJlZGlyZWN0VXJpKCkpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEFycmF5PHN0cmluZz4odGhpcy5tc2FsQ29uZmlnLmF1dGguY2xpZW50SWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgICogaW4gYW5ndWxhciBsZXZlbCwgdGhlIHVybCBmb3IgJGh0dHAgaW50ZXJjZXB0b3IgY2FsbCBjb3VsZCBiZSByZWxhdGl2ZSB1cmwsXHJcbiAgICAgICAgICAgICAqIGlmIGl0J3MgcmVsYXRpdmUgY2FsbCwgd2UnbGwgdHJlYXQgaXQgYXMgYXBwIGJhY2tlbmQgY2FsbC5cclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXk8c3RyaW5nPih0aGlzLm1zYWxDb25maWcuYXV0aC5jbGllbnRJZCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBpZiBub3QgdGhlIGFwcCdzIG93biBiYWNrZW5kIG9yIG5vdCBhIGRvbWFpbiBsaXN0ZWQgaW4gdGhlIGVuZHBvaW50cyBzdHJ1Y3R1cmVcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxufVxyXG5cclxuIl19